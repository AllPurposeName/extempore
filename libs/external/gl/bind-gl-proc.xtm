;;; bind-gl-proc.xtm

;; Author: Ben Swift
;; Keywords: extempore
;; Required dylibs: libGL

;;; Commentary:

;; This library contains some xtlang compiler additions to bind OpenGL
;; functions using the "GetProcAddress" approach. This stuff is pretty
;; messy, although hopefully it makes all the user-facing OpenGL code
;; cleaner.

;;; Code:

;; here are some compiler additions to deal with the messiness of
;; using GL extensions in a robust, cross-platform way. It's
;; necessary, but not necessarily nice - so let's keep it isolated in
;; this gl.xtm library

;; the basic idea is that we use a big array to keep track of the
;; OpenGL function pointers, and then create xtlang closures which
;; look up the right function pointer, cast it to the right signature,
;; and then call it with the required arguments

;; here's a big "lookup table" to match an OpenGL procedure name to an
;; index into the function pointer array. To re-create, load the
;; direct-bind version, and then:

;; (for-each (let ((count 0))
;;             (lambda (x)
;;               (set! count (+ count 1))
;;               (if (regex:match? (car x) "^gl")
;;                   (println (cons (car x) count)))))
;;           *impc:ti:nativefunc-cache*)

(define *impc:ti:gl-proc-alist*
  '(("glGetDoublei_v" . 1)
    ("glGetFloati_v" . 2)
    ("glDepthRangeIndexed" . 3)
    ("glDepthRangeArrayv" . 4)
    ("glScissorIndexedv" . 5)
    ("glScissorIndexed" . 6)
    ("glScissorArrayv" . 7)
    ("glViewportIndexedfv" . 8)
    ("glViewportIndexedf" . 9)
    ("glViewportArrayv" . 10)
    ("glGetVertexAttribLdv" . 11)
    ("glVertexAttribLPointer" . 12)
    ("glVertexAttribL4dv" . 13)
    ("glVertexAttribL3dv" . 14)
    ("glVertexAttribL2dv" . 15)
    ("glVertexAttribL1dv" . 16)
    ("glVertexAttribL4d" . 17)
    ("glVertexAttribL3d" . 18)
    ("glVertexAttribL2d" . 19)
    ("glVertexAttribL1d" . 20)
    ("glGetProgramPipelineInfoLog" . 21)
    ("glValidateProgramPipeline" . 22)
    ("glProgramUniformMatrix4x3dv" . 23)
    ("glProgramUniformMatrix3x4dv" . 24)
    ("glProgramUniformMatrix4x2dv" . 25)
    ("glProgramUniformMatrix2x4dv" . 26)
    ("glProgramUniformMatrix3x2dv" . 27)
    ("glProgramUniformMatrix2x3dv" . 28)
    ("glProgramUniformMatrix4x3fv" . 29)
    ("glProgramUniformMatrix3x4fv" . 30)
    ("glProgramUniformMatrix4x2fv" . 31)
    ("glProgramUniformMatrix2x4fv" . 32)
    ("glProgramUniformMatrix3x2fv" . 33)
    ("glProgramUniformMatrix2x3fv" . 34)
    ("glProgramUniformMatrix4dv" . 35)
    ("glProgramUniformMatrix3dv" . 36)
    ("glProgramUniformMatrix2dv" . 37)
    ("glProgramUniformMatrix4fv" . 38)
    ("glProgramUniformMatrix3fv" . 39)
    ("glProgramUniformMatrix2fv" . 40)
    ("glProgramUniform4uiv" . 41)
    ("glProgramUniform4ui" . 42)
    ("glProgramUniform4dv" . 43)
    ("glProgramUniform4d" . 44)
    ("glProgramUniform4fv" . 45)
    ("glProgramUniform4f" . 46)
    ("glProgramUniform4iv" . 47)
    ("glProgramUniform4i" . 48)
    ("glProgramUniform3uiv" . 49)
    ("glProgramUniform3ui" . 50)
    ("glProgramUniform3dv" . 51)
    ("glProgramUniform3d" . 52)
    ("glProgramUniform3fv" . 53)
    ("glProgramUniform3f" . 54)
    ("glProgramUniform3iv" . 55)
    ("glProgramUniform3i" . 56)
    ("glProgramUniform2uiv" . 57)
    ("glProgramUniform2ui" . 58)
    ("glProgramUniform2dv" . 59)
    ("glProgramUniform2d" . 60)
    ("glProgramUniform2fv" . 61)
    ("glProgramUniform2f" . 62)
    ("glProgramUniform2iv" . 63)
    ("glProgramUniform2i" . 64)
    ("glProgramUniform1uiv" . 65)
    ("glProgramUniform1ui" . 66)
    ("glProgramUniform1dv" . 67)
    ("glProgramUniform1d" . 68)
    ("glProgramUniform1fv" . 69)
    ("glProgramUniform1f" . 70)
    ("glProgramUniform1iv" . 71)
    ("glProgramUniform1i" . 72)
    ("glGetProgramPipelineiv" . 73)
    ("glIsProgramPipeline" . 74)
    ("glGenProgramPipelines" . 75)
    ("glDeleteProgramPipelines" . 76)
    ("glBindProgramPipeline" . 77)
    ("glCreateShaderProgramv" . 78)
    ("glActiveShaderProgram" . 79)
    ("glUseProgramStages" . 80)
    ("glProgramParameteri" . 81)
    ("glProgramBinary" . 82)
    ("glGetProgramBinary" . 83)
    ("glClearDepthf" . 84)
    ("glDepthRangef" . 85)
    ("glGetShaderPrecisionFormat" . 86)
    ("glShaderBinary" . 87)
    ("glReleaseShaderCompiler" . 88)
    ("glGetQueryIndexediv" . 89)
    ("glEndQueryIndexed" . 90)
    ("glBeginQueryIndexed" . 91)
    ("glDrawTransformFeedbackStream" . 92)
    ("glDrawTransformFeedback" . 93)
    ("glResumeTransformFeedback" . 94)
    ("glPauseTransformFeedback" . 95)
    ("glIsTransformFeedback" . 96)
    ("glGenTransformFeedbacks" . 97)
    ("glDeleteTransformFeedbacks" . 98)
    ("glBindTransformFeedback" . 99)
    ("glPatchParameterfv" . 100)
    ("glPatchParameteri" . 101)
    ("glGetProgramStageiv" . 102)
    ("glGetUniformSubroutineuiv" . 103)
    ("glUniformSubroutinesuiv" . 104)
    ("glGetActiveSubroutineName" . 105)
    ("glGetActiveSubroutineUniformName" . 106)
    ("glGetActiveSubroutineUniformiv" . 107)
    ("glGetSubroutineIndex" . 108)
    ("glGetSubroutineUniformLocation" . 109)
    ("glGetUniformdv" . 110)
    ("glUniformMatrix4x3dv" . 111)
    ("glUniformMatrix4x2dv" . 112)
    ("glUniformMatrix3x4dv" . 113)
    ("glUniformMatrix3x2dv" . 114)
    ("glUniformMatrix2x4dv" . 115)
    ("glUniformMatrix2x3dv" . 116)
    ("glUniformMatrix4dv" . 117)
    ("glUniformMatrix3dv" . 118)
    ("glUniformMatrix2dv" . 119)
    ("glUniform4dv" . 120)
    ("glUniform3dv" . 121)
    ("glUniform2dv" . 122)
    ("glUniform1dv" . 123)
    ("glUniform4d" . 124)
    ("glUniform3d" . 125)
    ("glUniform2d" . 126)
    ("glUniform1d" . 127)
    ("glDrawElementsIndirect" . 128)
    ("glDrawArraysIndirect" . 129)
    ("glBlendFuncSeparatei" . 130)
    ("glBlendFunci" . 131)
    ("glBlendEquationSeparatei" . 132)
    ("glBlendEquationi" . 133)
    ("glMinSampleShading" . 134)
    ("glVertexAttribP4uiv" . 135)
    ("glVertexAttribP4ui" . 136)
    ("glVertexAttribP3uiv" . 137)
    ("glVertexAttribP3ui" . 138)
    ("glVertexAttribP2uiv" . 139)
    ("glVertexAttribP2ui" . 140)
    ("glVertexAttribP1uiv" . 141)
    ("glVertexAttribP1ui" . 142)
    ("glVertexAttribDivisor" . 143)
    ("glGetQueryObjectui64v" . 144)
    ("glGetQueryObjecti64v" . 145)
    ("glQueryCounter" . 146)
    ("glGetSamplerParameterIuiv" . 147)
    ("glGetSamplerParameterfv" . 148)
    ("glGetSamplerParameterIiv" . 149)
    ("glGetSamplerParameteriv" . 150)
    ("glSamplerParameterIuiv" . 151)
    ("glSamplerParameterIiv" . 152)
    ("glSamplerParameterfv" . 153)
    ("glSamplerParameterf" . 154)
    ("glSamplerParameteriv" . 155)
    ("glSamplerParameteri" . 156)
    ("glBindSampler" . 157)
    ("glIsSampler" . 158)
    ("glDeleteSamplers" . 159)
    ("glGenSamplers" . 160)
    ("glGetFragDataIndex" . 161)
    ("glBindFragDataLocationIndexed" . 162)
    ("glSampleMaski" . 163)
    ("glGetMultisamplefv" . 164)
    ("glTexImage3DMultisample" . 165)
    ("glTexImage2DMultisample" . 166)
    ("glFramebufferTexture" . 167)
    ("glGetBufferParameteri64v" . 168)
    ("glGetInteger64i_v" . 169)
    ("glGetSynciv" . 170)
    ("glGetInteger64v" . 171)
    ("glWaitSync" . 172)
    ("glClientWaitSync" . 173)
    ("glDeleteSync" . 174)
    ("glIsSync" . 175)
    ("glFenceSync" . 176)
    ("glProvokingVertex" . 177)
    ("glMultiDrawElementsBaseVertex" . 178)
    ("glDrawElementsInstancedBaseVertex" . 179)
    ("glDrawRangeElementsBaseVertex" . 180)
    ("glDrawElementsBaseVertex" . 181)
    ("glUniformBlockBinding" . 182)
    ("glGetActiveUniformBlockName" . 183)
    ("glGetActiveUniformBlockiv" . 184)
    ("glGetUniformBlockIndex" . 185)
    ("glGetActiveUniformName" . 186)
    ("glGetActiveUniformsiv" . 187)
    ("glGetUniformIndices" . 188)
    ("glCopyBufferSubData" . 189)
    ("glPrimitiveRestartIndex" . 190)
    ("glTexBuffer" . 191)
    ("glDrawElementsInstanced" . 192)
    ("glDrawArraysInstanced" . 193)
    ("glIsVertexArray" . 194)
    ("glGenVertexArrays" . 195)
    ("glDeleteVertexArrays" . 196)
    ("glBindVertexArray" . 197)
    ("glFlushMappedBufferRange" . 198)
    ("glMapBufferRange" . 199)
    ("glFramebufferTextureLayer" . 200)
    ("glRenderbufferStorageMultisample" . 201)
    ("glBlitFramebuffer" . 202)
    ("glGenerateMipmap" . 203)
    ("glGetFramebufferAttachmentParameteriv" . 204)
    ("glFramebufferRenderbuffer" . 205)
    ("glFramebufferTexture3D" . 206)
    ("glFramebufferTexture2D" . 207)
    ("glFramebufferTexture1D" . 208)
    ("glCheckFramebufferStatus" . 209)
    ("glGenFramebuffers" . 210)
    ("glDeleteFramebuffers" . 211)
    ("glBindFramebuffer" . 212)
    ("glIsFramebuffer" . 213)
    ("glGetRenderbufferParameteriv" . 214)
    ("glRenderbufferStorage" . 215)
    ("glGenRenderbuffers" . 216)
    ("glDeleteRenderbuffers" . 217)
    ("glBindRenderbuffer" . 218)
    ("glIsRenderbuffer" . 219)
    ("glGetStringi" . 220)
    ("glClearBufferfi" . 221)
    ("glClearBufferfv" . 222)
    ("glClearBufferuiv" . 223)
    ("glClearBufferiv" . 224)
    ("glGetTexParameterIuiv" . 225)
    ("glGetTexParameterIiv" . 226)
    ("glTexParameterIuiv" . 227)
    ("glTexParameterIiv" . 228)
    ("glUniform4uiv" . 229)
    ("glUniform3uiv" . 230)
    ("glUniform2uiv" . 231)
    ("glUniform1uiv" . 232)
    ("glUniform4ui" . 233)
    ("glUniform3ui" . 234)
    ("glUniform2ui" . 235)
    ("glUniform1ui" . 236)
    ("glGetFragDataLocation" . 237)
    ("glBindFragDataLocation" . 238)
    ("glGetUniformuiv" . 239)
    ("glVertexAttribI4usv" . 240)
    ("glVertexAttribI4ubv" . 241)
    ("glVertexAttribI4sv" . 242)
    ("glVertexAttribI4bv" . 243)
    ("glVertexAttribI4uiv" . 244)
    ("glVertexAttribI3uiv" . 245)
    ("glVertexAttribI2uiv" . 246)
    ("glVertexAttribI1uiv" . 247)
    ("glVertexAttribI4iv" . 248)
    ("glVertexAttribI3iv" . 249)
    ("glVertexAttribI2iv" . 250)
    ("glVertexAttribI1iv" . 251)
    ("glVertexAttribI4ui" . 252)
    ("glVertexAttribI3ui" . 253)
    ("glVertexAttribI2ui" . 254)
    ("glVertexAttribI1ui" . 255)
    ("glVertexAttribI4i" . 256)
    ("glVertexAttribI3i" . 257)
    ("glVertexAttribI2i" . 258)
    ("glVertexAttribI1i" . 259)
    ("glGetVertexAttribIuiv" . 260)
    ("glGetVertexAttribIiv" . 261)
    ("glVertexAttribIPointer" . 262)
    ("glEndConditionalRender" . 263)
    ("glBeginConditionalRender" . 264)
    ("glClampColor" . 265)
    ("glGetTransformFeedbackVarying" . 266)
    ("glTransformFeedbackVaryings" . 267)
    ("glBindBufferBase" . 268)
    ("glBindBufferRange" . 269)
    ("glEndTransformFeedback" . 270)
    ("glBeginTransformFeedback" . 271)
    ("glIsEnabledi" . 272)
    ("glDisablei" . 273)
    ("glEnablei" . 274)
    ("glGetIntegeri_v" . 275)
    ("glGetBooleani_v" . 276)
    ("glColorMaski" . 277)
    ("glUniformMatrix4x3fv" . 278)
    ("glUniformMatrix3x4fv" . 279)
    ("glUniformMatrix4x2fv" . 280)
    ("glUniformMatrix2x4fv" . 281)
    ("glUniformMatrix3x2fv" . 282)
    ("glUniformMatrix2x3fv" . 283)
    ("glVertexAttribPointer" . 284)
    ("glVertexAttrib4usv" . 285)
    ("glVertexAttrib4uiv" . 286)
    ("glVertexAttrib4ubv" . 287)
    ("glVertexAttrib4sv" . 288)
    ("glVertexAttrib4s" . 289)
    ("glVertexAttrib4iv" . 290)
    ("glVertexAttrib4fv" . 291)
    ("glVertexAttrib4f" . 292)
    ("glVertexAttrib4dv" . 293)
    ("glVertexAttrib4d" . 294)
    ("glVertexAttrib4bv" . 295)
    ("glVertexAttrib4Nusv" . 296)
    ("glVertexAttrib4Nuiv" . 297)
    ("glVertexAttrib4Nubv" . 298)
    ("glVertexAttrib4Nub" . 299)
    ("glVertexAttrib4Nsv" . 300)
    ("glVertexAttrib4Niv" . 301)
    ("glVertexAttrib4Nbv" . 302)
    ("glVertexAttrib3sv" . 303)
    ("glVertexAttrib3s" . 304)
    ("glVertexAttrib3fv" . 305)
    ("glVertexAttrib3f" . 306)
    ("glVertexAttrib3dv" . 307)
    ("glVertexAttrib3d" . 308)
    ("glVertexAttrib2sv" . 309)
    ("glVertexAttrib2s" . 310)
    ("glVertexAttrib2fv" . 311)
    ("glVertexAttrib2f" . 312)
    ("glVertexAttrib2dv" . 313)
    ("glVertexAttrib2d" . 314)
    ("glVertexAttrib1sv" . 315)
    ("glVertexAttrib1s" . 316)
    ("glVertexAttrib1fv" . 317)
    ("glVertexAttrib1f" . 318)
    ("glVertexAttrib1dv" . 319)
    ("glVertexAttrib1d" . 320)
    ("glValidateProgram" . 321)
    ("glUniformMatrix4fv" . 322)
    ("glUniformMatrix3fv" . 323)
    ("glUniformMatrix2fv" . 324)
    ("glUniform4iv" . 325)
    ("glUniform3iv" . 326)
    ("glUniform2iv" . 327)
    ("glUniform1iv" . 328)
    ("glUniform4fv" . 329)
    ("glUniform3fv" . 330)
    ("glUniform2fv" . 331)
    ("glUniform1fv" . 332)
    ("glUniform4i" . 333)
    ("glUniform3i" . 334)
    ("glUniform2i" . 335)
    ("glUniform1i" . 336)
    ("glUniform4f" . 337)
    ("glUniform3f" . 338)
    ("glUniform2f" . 339)
    ("glUniform1f" . 340)
    ("glUseProgram" . 341)
    ("glShaderSource" . 342)
    ("glLinkProgram" . 343)
    ("glIsShader" . 344)
    ("glIsProgram" . 345)
    ("glGetVertexAttribPointerv" . 346)
    ("glGetVertexAttribiv" . 347)
    ("glGetVertexAttribfv" . 348)
    ("glGetVertexAttribdv" . 349)
    ("glGetUniformiv" . 350)
    ("glGetUniformfv" . 351)
    ("glGetUniformLocation" . 352)
    ("glGetShaderSource" . 353)
    ("glGetShaderInfoLog" . 354)
    ("glGetShaderiv" . 355)
    ("glGetProgramInfoLog" . 356)
    ("glGetProgramiv" . 357)
    ("glGetAttribLocation" . 358)
    ("glGetAttachedShaders" . 359)
    ("glGetActiveUniform" . 360)
    ("glGetActiveAttrib" . 361)
    ("glEnableVertexAttribArray" . 362)
    ("glDisableVertexAttribArray" . 363)
    ("glDetachShader" . 364)
    ("glDeleteShader" . 365)
    ("glDeleteProgram" . 366)
    ("glCreateShader" . 367)
    ("glCreateProgram" . 368)
    ("glCompileShader" . 369)
    ("glBindAttribLocation" . 370)
    ("glAttachShader" . 371)
    ("glStencilMaskSeparate" . 372)
    ("glStencilFuncSeparate" . 373)
    ("glStencilOpSeparate" . 374)
    ("glDrawBuffers" . 375)
    ("glBlendEquationSeparate" . 376)
    ("glGetBufferPointerv" . 377)
    ("glGetBufferParameteriv" . 378)
    ("glUnmapBuffer" . 379)
    ("glMapBuffer" . 380)
    ("glGetBufferSubData" . 381)
    ("glBufferSubData" . 382)
    ("glBufferData" . 383)
    ("glIsBuffer" . 384)
    ("glGenBuffers" . 385)
    ("glDeleteBuffers" . 386)
    ("glBindBuffer" . 387)
    ("glGetQueryObjectuiv" . 388)
    ("glGetQueryObjectiv" . 389)
    ("glGetQueryiv" . 390)
    ("glEndQuery" . 391)
    ("glBeginQuery" . 392)
    ("glIsQuery" . 393)
    ("glDeleteQueries" . 394)
    ("glGenQueries" . 395)
    ("glBlendEquation" . 396)
    ("glBlendColor" . 397)
    ("glPointParameteriv" . 398)
    ("glPointParameteri" . 399)
    ("glPointParameterfv" . 400)
    ("glPointParameterf" . 401)
    ("glMultiDrawElements" . 402)
    ("glMultiDrawArrays" . 403)
    ("glBlendFuncSeparate" . 404)
    ("glGetCompressedTexImage" . 405)
    ("glCompressedTexSubImage1D" . 406)
    ("glCompressedTexSubImage2D" . 407)
    ("glCompressedTexSubImage3D" . 408)
    ("glCompressedTexImage1D" . 409)
    ("glCompressedTexImage2D" . 410)
    ("glCompressedTexImage3D" . 411)
    ("glSampleCoverage" . 412)
    ("glActiveTexture" . 413)
    ("glCopyTexSubImage3D" . 414)
    ("glTexSubImage3D" . 415)
    ("glTexImage3D" . 416)
    ("glDrawRangeElements" . 417)
    ("glIsTexture" . 418)
    ("glGenTextures" . 419)
    ("glDeleteTextures" . 420)
    ("glBindTexture" . 421)
    ("glTexSubImage2D" . 422)
    ("glTexSubImage1D" . 423)
    ("glCopyTexSubImage2D" . 424)
    ("glCopyTexSubImage1D" . 425)
    ("glCopyTexImage2D" . 426)
    ("glCopyTexImage1D" . 427)
    ("glPolygonOffset" . 428)
    ("glGetPointerv" . 429)
    ("glDrawElements" . 430)
    ("glDrawArrays" . 431)
    ("glViewport" . 432)
    ("glDepthRange" . 433)
    ("glIsEnabled" . 434)
    ("glGetTexLevelParameteriv" . 435)
    ("glGetTexLevelParameterfv" . 436)
    ("glGetTexParameteriv" . 437)
    ("glGetTexParameterfv" . 438)
    ("glGetTexImage" . 439)
    ("glGetString" . 440)
    ("glGetIntegerv" . 441)
    ("glGetFloatv" . 442)
    ("glGetError" . 443)
    ("glGetDoublev" . 444)
    ("glGetBooleanv" . 445)
    ("glReadPixels" . 446)
    ("glReadBuffer" . 447)
    ("glPixelStorei" . 448)
    ("glPixelStoref" . 449)
    ("glDepthFunc" . 450)
    ("glStencilOp" . 451)
    ("glStencilFunc" . 452)
    ("glLogicOp" . 453)
    ("glBlendFunc" . 454)
    ("glFlush" . 455)
    ("glFinish" . 456)
    ("glEnable" . 457)
    ("glDisable" . 458)
    ("glDepthMask" . 459)
    ("glColorMask" . 460)
    ("glStencilMask" . 461)
    ("glClearDepth" . 462)
    ("glClearStencil" . 463)
    ("glClearColor" . 464)
    ("glClear" . 465)
    ("glDrawBuffer" . 466)
    ("glTexImage2D" . 467)
    ("glTexImage1D" . 468)
    ("glTexParameteriv" . 469)
    ("glTexParameteri" . 470)
    ("glTexParameterfv" . 471)
    ("glTexParameterf" . 472)
    ("glScissor" . 473)
    ("glPolygonMode" . 474)
    ("glPointSize" . 475)
    ("glLineWidth" . 476)
    ("glHint" . 477)
    ("glFrontFace" . 478)
    ("glCullFace" . 479)))

(define impc:ti:gl-proc-alist-index
  (let ()
    (lambda (gl-proc-name)
      (let ((res (assoc-strcmp gl-proc-name *impc:ti:gl-proc-alist*)))
        (if res (cdr res) #f)))))

(bind-val EXTEMPORE_GL_FUNCTION_POINTERS i8* 500) ;; currently at 479 elements

(define impc:aot:insert-gl-proc-binding-details
  (lambda (lib-name proc-name type docstring)
    (if (and (output-port? *impc:aot:current-output-port*)
             ;; ignore the binding if we're just binding something
             ;; from an Extempore AOT-compiled library
             (not (and (>= (string-length (atom->string lib-name)) 3)
                       (string=? "xtm" (substring (atom->string lib-name) 0 3)))))
        (begin
          (write
           (list 'bind-gl-proc lib-name proc-name type docstring)
           *impc:aot:current-output-port*)
          (newline *impc:aot:current-output-port*)))))

(define glwrapper-arg-list-symbols
  (lambda (arity)
    (map (lambda (i)
           (string->symbol (string-append "arg" (number->string (+ i 1)))))
         (range arity))))

(define-macro (bind-gl-proc gl-lib proc-name type . args)
  (let* ((arg-types (cddr (impc:ir:get-type-from-pretty-str (symbol->string type))))
         (arg-list (glwrapper-arg-list-symbols (length arg-types))))
    `(eval (bind-func ,proc-name
             ;; docstring
             ,(if (and (not (null? args)) (string? (car args)))
                  (car args)
                  "")
             (lambda ,arg-list
               ((convert (pref EXTEMPORE_GL_FUNCTION_POINTERS
                               ,(impc:ti:gl-proc-alist-index (symbol->string proc-name)))
                         ,type)
                ,@arg-list)))
           (interaction-environment))))

(impc:ti:register-new-builtin
 "bind-gl-proc"
 ""
 "bind an OpenGL procedure"
 '(libname function-name type optional-docstring))

(let ((platform (sys:platform)))
  (cond ((string=? platform "OSX")
         (eval '(bind-func gl_get_proc_address
                  (lambda (lib:i8* name:i8*)
                    (if (not (null? lib))
                        (dlsym lib name)
                        null)))
               (interaction-environment)))

        ((string=? platform "Linux")
         (eval '(bind-lib libGL glXGetProcAddressARB [i8*,i8*]*)
               (interaction-environment))
         (eval '(bind-func gl_get_proc_address
                  (lambda (lib:i8* name:i8*)
                    (glXGetProcAddressARB name)))
               (interaction-environment)))

        ((string=? platform "Windows")
         (eval '(bind-lib libGL wglGetProcAddress [i8*,i8*]*)
               (interaction-environment))
         (eval '(bind-func gl_get_proc_address
                  (lambda (lib:i8* name:i8*)
                    (wglGetProcAddress name)))
               (interaction-environment)))

        (else (impc:compiler:print-compiler-error
               "unknown platform, cannot load platform-specific gl_get_proc_address for OpenGL"))))

(bind-func gl_set_proc_address
  (lambda (index proc-fptr)
    (pset! EXTEMPORE_GL_FUNCTION_POINTERS index proc-fptr)))

(define gl_set_proc_adresses
  (lambda (gl-lib)
    (for-each (lambda (x)
                (gl_set_proc_address (cdr x) (gl_get_proc_address gl-lib (car x))))
              *impc:ti:gl-proc-alist*)))
