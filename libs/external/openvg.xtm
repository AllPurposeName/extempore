;;; openvg.xtm -- Vector Graphics (currently from ShivaVG)

;; Author: Andrew Sorensen
;; Keywords: extempore
;; Required dylibs: libShivaVG

;;; Commentary:

;;; Code:

;; lib-loading config
(sys:load-preload-check 'openvg)

;; load soil library
(define libopenvg
  (let ((platform (sys:platform)))
    (cond ((string=? platform "Linux") (sys:open-dylib "libOpenVG.so"))
	  ((string=? platform "Windows") (sys:open-dylib "libOpenVG.dll"))
	  ((string=? platform "OSX") (sys:open-dylib "libOpenVG.dylib"))
	  (else (sys:load-escape "Unknown platform for OpenVG lib")))))

(if (null? libopenvg)
    (sys:load-escape "Could not load OpenVG\n"))

(sys:load "libs/external/image.xtm")

(define *xtmlib-openvg-loaded* #f)

(bind-alias VGboolean i32)
(bind-val VG_FALSE i32 0)
(bind-val VG_TRUE i32 1)
(bind-alias VGint i32)
(bind-alias VGuint i32)
(bind-alias VGbitfield i32)
(bind-alias VGfloat float)
(bind-alias VGbyte i8)
(bind-alias VGubyte i8)
(bind-alias VGshort i16)

(bind-alias VGHandle i8*)
(bind-alias VGPath i8*)
(bind-alias VGPaint i8*)
(bind-alias VGImage i8*)

(bind-val VG_PATH_FORMAT_STANDARD i32 0)

;; enums
(bind-alias VGPathDatatype enum)
(bind-val VG_PATH_DATATYPE_F VGPathDatatype 3)

(bind-alias VGPathCapabilities enum)
(bind-val VG_PATH_CAPABILITY_ALL VGPathCapabilities (real->integer (- (expt 2 12) 1)))

(bind-alias VGPathAbsRel enum)
(bind-val VG_ABSOLUTE VGPathAbsRel 0)
(bind-val VG_RELATIVE VGPathAbsRel 1)

(bind-alias VGPathSegment enum)
(bind-val VG_CLOSE_PATH VGPathSegment 0)
(bind-val VG_MOVE_TO VGPathSegment 2)
(bind-val VG_LINE_TO VGPathSegment 4)
(bind-val VG_HLINE_TO VGPathSegment 6)
(bind-val VG_VLINE_TO VGPathSegment 8)
(bind-val VG_QUAD_TO VGPathSegment 10)
(bind-val VG_CUBIC_TO VGPathSegment 12)
(bind-val VG_SCUBIC_TO VGPathSegment 14)
(bind-val VG_SCCWARC_TO VGPathSegment 16)
(bind-val VG_SCWARC_TO VGPathSegment 18)
(bind-val VG_LCCWARC_TO VGPathSegment 20)
(bind-val VG_LCWARC_TO VGPathSegment 22)

(bind-alias VGPaintMode enum)
(bind-val VG_STROKE_PATH VGPaintMode 1)
(bind-val VG_FILL_PATH VGPaintMode 2)

(bind-alias VGErrorCode enum)
(bind-val VG_NO_ERROR VGErrorCode 0)

(bind-alias VGParamType enum)
(bind-val VG_MATRIX_MODE VGParamType 4352)
(bind-val VG_FILL_RULE VGParamType 4353)
(bind-val VG_IMAGE_QUALITY VGParamType 4354)
(bind-val VG_RENDERING_QUALITY VGParamType 4355)
(bind-val VG_BLEND_MODE VGParamType 4356)
(bind-val VG_IMAGE_MODE VGParamType 4357)

(bind-alias VGPaintParamType enum)
(bind-val VG_PAINT_TYPE VGPaintParamType 6656)
(bind-val VG_PAINT_COLOR VGPaintParamType 6657)

(bind-alias VGPaintType enum)
(bind-val VG_PAINT_TYPE_COLOR VGPaintType 6912)
(bind-val VG_PAINT_TYPE_LINEAR_GRADIENT VGPaintType 6913)
(bind-val VG_PAINT_TYPE_RADIAL_GRADIENT VGPaintType 6914)
(bind-val VG_PAINT_TYPE_PATTERN VGPaintType 6915)
(bind-val VG_CLEAR_COLOR VGPaintType 4385)
(bind-val VG_STROKE_LINE_WIDTH VGPaintType 4368)

(bind-alias VGMatrixMode enum)
(bind-val VG_MATRIX_PATH_USER_TO_SURFACE VGMatrixMode 5120)
(bind-val VG_MATRIX_IMAGE_USER_TO_SURFACE VGMatrixMode 5121)
(bind-val VG_MATRIX_FILL_PAINT_TO_USER VGMatrixMode 5122)
(bind-val VG_MATRIX_STROKE_PAINT_TO_USER VGMatrixMode 5123)

(bind-alias VGImageFormat enum)
(bind-val VG_sRGBX_8888 VGImageFormat 0)
(bind-val VG_sRGBA_8888 VGImageFormat 1)
(bind-val VG_sRGBA_8888_PRE VGImageFormat 2)
(bind-val VG_lRGBX_8888 VGImageFormat 7)
(bind-val VG_lRGBA_8888 VGImageFormat 8)
(bind-val VG_lRGBA_8888_PRE VGImageFormat 9)
(bind-val VG_lARGB_8888 VGImageFormat 200)

(bind-alias VGBlendMode enum)
(bind-val VG_BLEND_SRC VGBlendMode 8192)

(bind-alias VGImageMode enum)
(bind-val VG_DRAW_IMAGE_NORMAL VGImageMode 7936)
(bind-val VG_DRAW_IMAGE_MULTIPLY VGImageMode 7937)
(bind-val VG_DRAW_IMAGE_STENCIL VGImageMode 7938)

(bind-alias VGRenderingQuality enum)
(bind-val VG_RENDERING_QUALITY_BETTER VGRenderingQuality 4610)
(bind-val VG_IMAGE_QUALITY_BETTER VGRenderingQuality 4)

(bind-lib libopenvg vgCreateContextSH [VGboolean,VGint,VGint]*)
(bind-lib libopenvg vgCreatePath [VGPath,VGint,VGPathDatatype,VGfloat,VGfloat,VGint,VGint,VGbitfield]*)
(bind-lib libopenvg vgClearPath [void,VGPath,VGbitfield]*)
(bind-lib libopenvg vgDestroyPath [void,VGPath]*)
(bind-lib libopenvg vgClear [void,VGint,VGint,VGint,VGint]*)
(bind-lib libopenvg vgAppendPath [void,VGPath,VGPath]*)
(bind-lib libopenvg vgAppendPathData [void,VGPath,VGint,VGubyte*,i8*]*)
(bind-lib libopenvg vgDrawPath [void,VGPath,VGbitfield]*)
(bind-lib libopenvg vgPathBounds [void,VGPath,VGfloat*,VGfloat*,VGfloat*,VGfloat*]*)
(bind-lib libopenvg vgCreatePaint [VGPaint]*)
(bind-lib libopenvg vgDestroyPaint [void,VGPaint]*)
(bind-lib libopenvg vgSetPaint [void,VGPaint,VGbitfield]*)
;; (bind-lib libopenvg vgSetColor [void,VGPaint,VGuint]*)
(bind-lib libopenvg vgSetfv [void,VGParamType,VGint,VGfloat*]*)
(bind-lib libopenvg vgSetiv [void,VGParamType,VGint,VGint*]*)
(bind-lib libopenvg vgSeti [void,VGParamType,VGint]*)
(bind-lib libopenvg vgSetf [void,VGParamType,VGfloat]*)

(bind-lib libopenvg vgLoadIdentity [void]*)
(bind-lib libopenvg vgTranslate [void,VGfloat,VGfloat]*)
(bind-lib libopenvg vgScale [void,VGfloat,VGfloat]*)
(bind-lib libopenvg vgRotate [void,VGfloat]*)



(bind-lib libopenvg vgSetParameterfv [void,VGHandle,VGint,VGint,VGfloat*]*)
(bind-lib libopenvg vgSetParameteri [void,VGHandle,VGint,VGint]*)
(bind-lib libopenvg vgGetError [VGErrorCode]*)

;; image
(bind-lib libopenvg vgCreateImage [VGImage,VGImageFormat,VGint,VGint,VGbitfield]*)
(bind-lib libopenvg vgImageSubData [void,VGImage,i8*,VGint,VGImageFormat,VGint,VGint,VGint,VGint]*)
(bind-lib libopenvg vgDrawImage [void,VGImage]*)

;; vgu
(bind-lib libopenvg vguLine [VGErrorCode,VGPath,VGfloat,VGfloat,VGfloat,VGfloat]*)
(bind-lib libopenvg vguEllipse [VGErrorCode,VGPath,VGfloat,VGfloat,VGfloat,VGfloat]*)

(bind-func vgCreateContext
  (lambda (w h)
    (vgCreateContextSH w h)))

(bind-func xtm_create_vgpath
  (lambda ()
    (vgCreatePath VG_PATH_FORMAT_STANDARD VG_PATH_DATATYPE_F
                  1.0 0.0 0 0
                  VG_PATH_CAPABILITY_ALL)))

(bind-func xtm_create_vgimage
  (lambda (path)
    (let ((w:i32* (alloc))
          (h:i32* (alloc))
          (c:i32* (alloc))
          (i 0)
          (row:i8* null)
          (data:i8* (SOIL_load_image path w h c SOIL_LOAD_RGBA))
          (img (vgCreateImage VG_lARGB_8888 (pref w 0) (pref h 0)
                              VG_IMAGE_QUALITY_BETTER)))
      ;; flip image
      (dotimes (i (pref h 0))
        (set! row (pref-ptr data (* i (* (pref w 0) 4))))
        (vgImageSubData img row (* (pref w 0) 4) VG_lARGB_8888
                        0
                        (- (pref h 0) i 1)  (pref w 0) 1))
      img)))
      
(define *xtmlib-openvg-loaded* #t)
