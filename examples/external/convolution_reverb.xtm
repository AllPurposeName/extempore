;;
;; convolution.xtm
;;
;; A partitioned convolution reverb
;; this has not been optimized so you
;; will almost certainly need to increase
;; your FRAME size when starting extempore
;; try --frames=512 with this example
;;
;; Author: Andrew Sorensen
;; Keywords: extempore
;; Required dylibs: libsndfile fft
;;

;;; Code:

;; try loading xtm.xtm first
(sys:load "libs/xtm.xtm")
;; failing that fall through to these
(sys:load "libs/external/audio_dsp_ext.xtm")
(sys:load "libs/external/instruments_ext.xtm")

;; convolution reverb takes mono
;; files as input (i.e. separates left and right)
(bind-func dsp:DSP 100000000
  (let ((reverb (creverb_st_c "assets/ir/minsterl.aif"
                              "assets/ir/minsterr.aif"))
        (wet 2.0)
        (dry 0.3))    
    (lambda (in time chan dat)
      (reverb chan (sampler in time chan dat) dry wet))))

(dsp:set! dsp)

;; load up the sampler!
(load-sampler sampler "~/Documents/samples/soprano/")

(sampler.release 5000)
(sampler.attack 2000)

(dsp.wet 2.0)
(dsp.dry 0.0)

;; make some noise
(define test
  (lambda (beat dur)
    (play sampler 72 120 10.0 0 0.2)
    (play 2 sampler 77 120 10.0 0 0.8)
    (play 4 sampler 68 125 8.0 0 0.6)
    (play 7 sampler 75 120 12.0 0 0.4)
    (play 10 sampler 70 125 11.0 0 0.55)
    (play 12 sampler 67 130 7.0 0 0.45)
    (callback (*metro* (+ beat (* .5 dur))) 'test (+ beat dur) dur)))

(test (*metro* 'get-beat 4) 16)

(define print-load
  (lambda (beat dur)
    (println 'load: (* 100. (sys:audio-load)))
    (callback (*metro* (+ beat (* .5 dur))) 'print-load (+ beat dur) dur)))

(print-load (*metro* 'get-beat 4) 1)
