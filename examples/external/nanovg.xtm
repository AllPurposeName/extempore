;;; nanovg.xtm:examples -- nanovg example

;; Author: Ben Swift
;; Keywords: extempore
;; Required dylibs: libnanovg

;;; Commentary:

;;

;;; Code:

(sys:load "libs/external/glfw3.xtm")
(sys:load "libs/external/nanovg.xtm")

(bind-val window GLFWwindow*)

(call-as-xtlang
 (set! window (glfw_init_and_create_fullscreen_window)))

(bind-val vg NVGcontext*)

(call-as-xtlang
 (set! vg (nvgCreateGL3 (+ NVG_ANTIALIAS NVG_STENCIL_STROKES NVG_DEBUG))))

(call-as-xtlang
 (glEnable GL_STENCIL_TEST))

(call-as-xtlang
 (let ((bits:i32* (salloc)))
   (glGetIntegerv GL_MAX_DEPTH_TEXTURE_SAMPLES bits)
   (println "stencil buffer bit depth: " (pref bits 0))))

(bind-val width float 1920.0)
(bind-val height float 1080.0)

(bind-func nanovg_draw
  (lambda ()
    (if (null? vg)
        (println "Error: vg is null.")
        (begin
          ;; (nvgBeginFrame vg (convert width) (convert height) 1.0)
          (nvgBeginPath vg)
          (nvgRect vg 100. 100. 520. 430.)
          (nvgFillColor vg (pref (NVGcolor 1. .7 0. 1.) 0))
          (nvgFill vg)
          (gl_print_error "draw:")
          (nvgEndFrame vg)
          (glfwSwapBuffers window)))))

(define gl-loop
  (lambda (time delta-t)
    (let ((late-by (- (now) time))
          (next-frame-time (+ time (* *second* delta-t))))
      (if (> late-by 0)
          (print "Late by " (* 1.0 (/ late-by *second*)) "seconds\n")
          (nanovg_draw))
      (callback (* 0.9 next-frame-time)
                'gl-loop
                next-frame-time
                delta-t))))

(gl-loop (now) 1)
